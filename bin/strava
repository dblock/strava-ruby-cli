#!/usr/bin/env ruby
require 'gli'
require 'ripl'

require_relative '../lib/strava-ruby-cli'

class App
  extend GLI::App

  program_desc "Command-line client for Strava #{Strava::VERSION}."
  version Strava::Cli::VERSION

  switch %i[v verbose], desc: 'Produce verbose output.', default_value: false
  flag %i[i client_id], desc: 'Strava client ID.', default_value: ENV['STRAVA_CLIENT_ID']
  flag %i[s client_secret], desc: 'Strava client secret.', default_value: ENV['STRAVA_CLIENT_SECRET']
  flag %i[t access_token], desc: 'Strava access token.', default_value: ENV['STRAVA_ACCESS_TOKEN']

  arguments :strict
  subcommand_option_handling :normal

  default_command :help

  pre do |global_options, _command, options, _args|
    options = global_options.dup
    $auth = Strava::Cli::Auth.new(options)
  end

  desc 'Opens a Strava console'
  command :console do |c|
    c.action do |_global_options, _options, _args|
      access_token = $auth.access_token
      console = Strava::Cli::Console.new(access_token)
      console.start! if access_token
    end
  end
end

exit App.run(ARGV)
